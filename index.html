<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan H·∫°n S·ª≠ D·ª•ng</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 1rem; background-color: #f0f2f5; color: #1c1e21; }
        .container { max-width: 500px; margin: auto; background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #4285F4; }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
        .input-group { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        .input-group input { flex-grow: 1; }
        input, select, button { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        button { border: none; color: white; cursor: pointer; }
        #scanButton { background-color: #0F9D58; } /* M√†u xanh l√° */
        #submitButton { background-color: #4285F4; margin-top: 1rem; } /* M√†u xanh d∆∞∆°ng */
        #reader { width: 100%; border: 1px dashed #ccc; border-radius: 8px; margin-bottom: 1rem; display: none; }
        #message { text-align: center; margin-top: 1rem; font-weight: bold; }
        .date-group { display: flex; gap: 1rem; }
    </style>
</head>
<body>

<div class="container">
    <h2>Nh·∫≠p H·∫°n S·ª≠ D·ª•ng</h2>

    <div id="reader"></div>

    <form id="dataForm">
        <label for="barcodeInput">Barcode</label>
        <div class="input-group">
            <input type="text" id="barcodeInput" name="barcode" placeholder="Nh·∫≠p tay ho·∫∑c qu√©t m√£" required>
            <button type="button" id="scanButton">üì∑ Scan</button>
        </div>

        <label>Ng√†y / Th√°ng H·∫øt H·∫°n</label>
        <div class="date-group">
            <input type="number" id="ngayInput" name="ngay" placeholder="Ng√†y" min="1" max="31" required>
            <input type="number" id="thangInput" name="thang" placeholder="Th√°ng" min="1" max="12" required>
        </div>

        <button type="submit" id="submitButton">L∆∞u D·ªØ Li·ªáu</button>
    </form>

    <div id="message"></div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
    const form = document.getElementById('dataForm');
    const scanButton = document.getElementById('scanButton');
    const barcodeInput = document.getElementById('barcodeInput');
    const readerDiv = document.getElementById('reader');
    const messageDiv = document.getElementById('message');
    let isScannerOn = false;

    // Kh·ªüi t·∫°o tr√¨nh qu√©t m√£
    const html5QrCode = new Html5Qrcode("reader");

    const qrCodeSuccessCallback = (decodedText, decodedResult) => {
        // ƒêi·ªÅn barcode v√†o √¥ input
        barcodeInput.value = decodedText;
        // T·∫Øt camera sau khi qu√©t th√†nh c√¥ng
        stopScanner();
    };

    function startScanner() {
        readerDiv.style.display = 'block';
        scanButton.textContent = 'üì∑ ƒêang qu√©t...';
        isScannerOn = true;
        
        // B·∫Øt ƒë·∫ßu qu√©t b·∫±ng camera sau c·ªßa ƒëi·ªán tho·∫°i
        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 150 } },
            qrCodeSuccessCallback,
            (errorMessage) => { /* console.log(errorMessage); */ }
        ).catch((err) => {
            alert("Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông camera. Vui l√≤ng c·∫•p quy·ªÅn v√† th·ª≠ l·∫°i.");
            stopScanner();
        });
    }

    function stopScanner() {
        if (isScannerOn) {
            html5QrCode.stop().then(() => {
                readerDiv.style.display = 'none';
                scanButton.textContent = 'üì∑ Scan';
                isScannerOn = false;
            }).catch(err => console.error("L·ªói khi d·ª´ng camera:", err));
        }
    }
    
    // X·ª≠ l√Ω khi nh·∫•n n√∫t Scan/T·∫Øt
    scanButton.addEventListener('click', () => {
        if (isScannerOn) {
            stopScanner();
        } else {
            startScanner();
        }
    });

    // X·ª≠ l√Ω khi g·ª≠i form
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        messageDiv.textContent = 'ƒêang l∆∞u...';
        messageDiv.style.color = 'black';

        const formData = new FormData(form);
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxgDgzA9FB0fQcE0cpS9I62zwKq4f7y8dhlTukKJ2AcpI_JQtszQvYl2Uuav8DGu9a_AQ/exec'; // <--- THAY URL C·ª¶A B·∫†N V√ÄO ƒê√ÇY

        fetch(scriptURL, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                if(data.result === 'success') {
                    messageDiv.textContent = 'L∆∞u th√†nh c√¥ng!';
                    messageDiv.style.color = 'green';
                    form.reset(); // X√≥a d·ªØ li·ªáu ƒë√£ nh·∫≠p
                } else {
                    throw new Error(data.message || 'L∆∞u th·∫•t b·∫°i');
                }
            })
            .catch(error => {
                messageDiv.textContent = 'ƒê√£ c√≥ l·ªói x·∫£y ra! ' + error.message;
                messageDiv.style.color = 'red';
            });
    });
</script>

</body>
</html>